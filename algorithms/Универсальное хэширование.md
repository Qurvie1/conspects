Мы хотим найти небольшое подмножество $H$ такое, что оно было бы [[Хэш-таблицы|ПРХ]] (простое равномерное).

**Определение**. Подмножество $H$ универсально, если вероятность коллизии $\leq \frac{1}{m}$

Метод цепочек работает также, просто вероятность меньше, чем $\frac{1}{m}$, то есть будет неравенство.

Пример - если у нас множество ключей - это множество вычетов по модулю $p$, то множество $H$ определяется функциями $h(x) = ((ax + b) \mod p) \mod m$

Почему так?

При разных $x \ne y$ будет
$x' - y' = a(x + y) \mod p$ - не равно 0, то есть нет коллизий.

При этом для любых $x, x', y, y'$ существуют и единственны $a, b$ такие, что $h(x) = x'$ и $h(y) = y'$ (решение системы линейных уравнений).

Какой шанс, что совпадут $x'$ и $y'$?

$$
P = \frac{p(\frac{p}{m} - 1)}{p(p - 1)}
$$
И оно удовлетворяет тому, что $P \leq \frac{1}{m}$

Переходим к идеальному хэшированию.
Хотим на статическом множестве построить хэш-таблицу без коллизий.

Пусть $C$ - число коллизий.

$C = \sum\limits I(h(x_{i}) = h(x_{j}))$

Среднее число коллизий:
$$
EC = \sum\limits P(h(x_{i}) = h(x_{j})) \leq \sum\limits \frac{1}{m} = \frac{n(n - 1)}{2} \frac{1}{m}
$$

**Лемма Маркова**.

Пусть $X$ - натуральная случайная величина.

Тогда для любого $e > 0$, вероятность того, что $X \geq e$:
$$
P \leq \frac{EX}{e}
$$

**Теорема**. Пусть $h$ - из универсального семейства и $m = n^{2}$, тогда $P(C \geq 1) < \frac{1}{2}$
$$
P(C \geq 1) \leq \frac{EC}{1} \leq \frac{n(n - 1)}{2m} < \frac{1}{2}
$$
Но это требует много памяти. Как решим.

Будем хранить в одной хэш таблице много хэш таблиц и просто сделаем размер каждой хэш таблицы равным $n_{i}^{2}$

То есть в большую хэш таблицу, пусть попадают элементы $x, y$, они образуют коллизию.

Тогда сделаем маленькую хэш таблицу на этом хэше размером $n_{i}^{2} = 2^{2}$ (тут)

**Теорема 3**. Пусть $m = n$ (глобальное). В корзину $i$ попало $n_{i}$ элементов.

Тогда $E\sum\limits n_{i}^{2} < 2n$

$$
E\sum\limits n_{i}^{2} = E \left(2\sum\limits \frac{n_{i}(n_{i} - 1)}{2} + \sum\limits n_{i}\right) = 2EC + n = \frac{2n(n - 1)}{2m} + n < 2n, m = n
$$


Следствие.

$P\left(\sum\limits n_{i}^{2} > 4n\right) < \frac{1}{2}$

$$
P \leq \frac{E\sum\limits n_{i}^{2}}{4n} < \frac{2n}{4n} < \frac{1}{2}
$$

Тогда алгоритм FKS.

1) Строим внешнюю хэш таблицу $m = n$ выбираем случайную $h$.
2) Если $\sum\limits n_{i}^{2} \geq 4n$, то повторяем 1 заново (будет максимум 2 итерации по третьей теореме)
3) Для каждой ячейки $i$ строим $m_{i} = n_{i}^{2}$ и выбираем $h_{i}$ 
4) Если есть коллизии, то опять же повторим 3 пункт (максимум 2 итерации по штуке выше).

Время построения $T(n) = \Theta(n)$ - в среднем, память линейная в худшем

**Поиск за константу**.